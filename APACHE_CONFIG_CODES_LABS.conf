# ========================================
# CONFIGURACIÓN APACHE PARA CODES-LABS
# DirectAdmin - Adaptado del patrón femimed
# ========================================

# ========================================
# DOMINIO PRINCIPAL - codes-labs.com
# Frontend Angular
# ========================================

<VirtualHost 69.164.244.24:80 >
        ServerName www.codes-labs.com
        ServerAlias www.codes-labs.com codes-labs.com
        ServerAdmin webmaster@codes-labs.com
        DocumentRoot "/home/admin/domains/codes-labs.com/public_html"
        ScriptAlias /cgi-bin/ "/home/admin/domains/codes-labs.com/public_html/cgi-bin/"
        UseCanonicalName OFF
        SuexecUserGroup admin admin
        CustomLog /var/log/httpd/domains/codes-labs.com.bytes bytes
        CustomLog /var/log/httpd/domains/codes-labs.com.log combined
        ErrorLog /var/log/httpd/domains/codes-labs.com.error.log

        # CRÍTICO: Permitir .well-known para Let's Encrypt (ANTES de redirección)
        Alias /.well-known /home/admin/domains/codes-labs.com/public_html/.well-known
        <Directory "/home/admin/domains/codes-labs.com/public_html/.well-known">
                Options None
                AllowOverride None
                Require all granted
        </Directory>

        # Redirección HTTP a HTTPS (excepto .well-known)
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^/\.well-known
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

        <Directory "/home/admin/domains/codes-labs.com/public_html">
                Options -Indexes +FollowSymLinks
                AllowOverride All
                Require all granted
        </Directory>

        # Mail auto configuration (Thunderbird)
        ProxyPassMatch "^/\.well-known/autoconfig/mail/config-v1\.1\.xml$" "unix:/usr/local/directadmin/shared/internal.sock|http://localhost"
</VirtualHost>

<VirtualHost 69.164.244.24:443 >
        SSLEngine on
        SSLCertificateFile /etc/letsencrypt/live/codes-labs.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/codes-labs.com/privkey.pem
        ServerName www.codes-labs.com
        ServerAlias www.codes-labs.com codes-labs.com
        ServerAdmin webmaster@codes-labs.com
        DocumentRoot "/home/admin/domains/codes-labs.com/public_html"
        ScriptAlias /cgi-bin/ "/home/admin/domains/codes-labs.com/public_html/cgi-bin/"
        UseCanonicalName OFF
        SuexecUserGroup admin admin
        CustomLog /var/log/httpd/domains/codes-labs.com.bytes bytes
        CustomLog /var/log/httpd/domains/codes-labs.com.log combined
        ErrorLog /var/log/httpd/domains/codes-labs.com.error.log

        <Directory "/home/admin/domains/codes-labs.com/public_html">
                Options -Indexes +FollowSymLinks
                AllowOverride All
                Require all granted
                
                # Configuración para SPA Angular - redirigir todas las rutas a index.html
                RewriteEngine On
                RewriteBase /
                RewriteRule ^index\.html$ - [L]
                RewriteCond %{REQUEST_FILENAME} !-f
                RewriteCond %{REQUEST_FILENAME} !-d
                RewriteRule . /index.html [L]
        </Directory>

        # Mail auto configuration (Thunderbird)
        ProxyPassMatch "^/\.well-known/autoconfig/mail/config-v1\.1\.xml$" "unix:/usr/local/directadmin/shared/internal.sock|http://localhost"
</VirtualHost>

# ========================================
# SUBDOMINIO API - api.codes-labs.com
# Backend Node.js: Puerto 3001
# ========================================

<VirtualHost 69.164.244.24:80 >
        ServerName www.api.codes-labs.com
        ServerAlias www.api.codes-labs.com api.codes-labs.com
        ServerAdmin webmaster@codes-labs.com
        DocumentRoot "/home/admin/domains/api.codes-labs.com.codes-labs.com/public_html"
        ScriptAlias /cgi-bin/ "/home/admin/domains/api.codes-labs.com.codes-labs.com/public_html/cgi-bin/"
        UseCanonicalName OFF
        SuexecUserGroup admin admin
        CustomLog /var/log/httpd/domains/codes-labs.com.api.bytes bytes
        CustomLog /var/log/httpd/domains/codes-labs.com.api.log combined
        ErrorLog /var/log/httpd/domains/codes-labs.com.api.error.log

        # CRÍTICO: Permitir .well-known para Let's Encrypt (ANTES de redirección)
        Alias /.well-known /home/admin/domains/api.codes-labs.com.codes-labs.com/public_html/.well-known
        <Directory "/home/admin/domains/api.codes-labs.com.codes-labs.com/public_html/.well-known">
                Options None
                AllowOverride None
                Require all granted
        </Directory>

        # Redirección HTTP a HTTPS (excepto .well-known)
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^/\.well-known
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

        <Directory "/home/admin/domains/api.codes-labs.com.codes-labs.com/public_html">
                Options -Indexes +FollowSymLinks
                AllowOverride All
                Require all granted
        </Directory>
</VirtualHost>

<VirtualHost 69.164.244.24:443 >
        SSLEngine on
        SSLCertificateFile /etc/letsencrypt/live/api.codes-labs.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/api.codes-labs.com/privkey.pem
        ServerName www.api.codes-labs.com
        ServerAlias www.api.codes-labs.com api.codes-labs.com
        ServerAdmin webmaster@codes-labs.com
        DocumentRoot "/home/admin/domains/api.codes-labs.com.codes-labs.com/public_html"
        ScriptAlias /cgi-bin/ "/home/admin/domains/api.codes-labs.com.codes-labs.com/public_html/cgi-bin/"
        UseCanonicalName OFF
        SuexecUserGroup admin admin
        CustomLog /var/log/httpd/domains/codes-labs.com.api.bytes bytes
        CustomLog /var/log/httpd/domains/codes-labs.com.api.log combined
        ErrorLog /var/log/httpd/domains/codes-labs.com.api.error.log

        # Configuración de Proxy - DEBE IR ANTES del Directory
        ProxyPreserveHost On
        ProxyRequests Off

        # Habilitar módulos necesarios (verificar que estén habilitados)
        # LoadModule proxy_module modules/mod_proxy.so
        # LoadModule proxy_http_module modules/mod_proxy_http.so
        # LoadModule headers_module modules/mod_headers.so
        # LoadModule rewrite_module modules/mod_rewrite.so

        # Proxy para /health (health check endpoint)
        ProxyPass /health http://localhost:3001/health nocanon
        ProxyPassReverse /health http://localhost:3001/health

        # Proxy para /api (todos los endpoints de la API)
        ProxyPass /api http://localhost:3001/api nocanon
        ProxyPassReverse /api http://localhost:3001/api

        # Headers CORS (el backend también maneja CORS, pero esto ayuda)
        Header always set Access-Control-Allow-Origin "https://codes-labs.com"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
        Header always set Access-Control-Allow-Credentials "true"

        # Manejar preflight OPTIONS
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]

        <Directory "/home/admin/domains/api.codes-labs.com/public_html">
                Options -Indexes +FollowSymLinks
                AllowOverride All
                Require all granted
        </Directory>
</VirtualHost>

